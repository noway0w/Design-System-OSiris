<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Live Tracking Map Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13a4ec",
            "background-light": "#EFF2F9",
            "background-dark": "#101c22",
            "card-light": "#E4EBF1",
            "card-dark": "#1c262d",
            "text-secondary": "#9db0b9",
          },
          fontFamily: { "display": ["Plus Jakarta Sans", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
        },
      },
    }
  </script>
  <link href="css/neumorphic-menu.css" rel="stylesheet"/>
  <link href="css/variables.css" rel="stylesheet"/>
  <link href="css/components/core-actions.css" rel="stylesheet"/>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
  <style>
    .map-marker-pulse { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.8; }
      50% { opacity: 0.4; }
      100% { transform: scale(2.4); opacity: 0; }
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes tile-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .tile-fade-in { animation: tile-fade-in 0.5s ease-in forwards; }
    .toast-error {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 60;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 12px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    .toast-error { background: #E4EBF1; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    html.dark .toast-error { background: #1c262d; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .toast-error.visible {
      opacity: 1;
      visibility: visible;
    }
    .toast-error .toast-close {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(0,0,0,0.08);
      color: inherit;
      cursor: pointer;
      transition: background 0.2s;
    }
    html.dark .toast-error .toast-close { background: rgba(255,255,255,0.1); color: white; }
    .toast-error .toast-close:hover { background: rgba(0,0,0,0.12); }
    html.dark .toast-error .toast-close:hover { background: rgba(255,255,255,0.2); }
    #map-container-wrap { background: #010b19; transition: background 0.3s ease; }
    html.light #map-container-wrap { background: #d4dae5; }
    .toggle-checkbox { top: 0; left: 0; right: auto; transition: left 0.2s, right 0.2s; }
    .toggle-checkbox:checked { left: auto; right: 0; border-color: #13a4ec !important; }
    .toggle-checkbox:checked + .toggle-label { background-color: #13a4ec; }
  </style>
  <script src="js/theme-service.js"></script>
  <script>if (typeof ThemeService !== 'undefined') ThemeService.init();</script>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display overflow-hidden h-screen flex flex-col antialiased selection:bg-primary selection:text-white">
  <div id="map-app-root" class="relative flex-1 min-h-0 overflow-hidden">
    <!-- Map Container (always full screen) -->
    <div id="map-container-wrap" class="absolute inset-0">
      <div id="map-app-container" class="absolute inset-0 w-full h-full"></div>
      <div id="map-gradient-overlay" class="absolute inset-0 bg-gradient-to-t from-background-light dark:from-background-dark via-transparent to-background-light/30 dark:to-background-dark/30 pointer-events-none transition-opacity duration-300"></div>

    </div>
    <!-- Top Bar Overlay -->
    <div class="absolute top-0 left-0 right-0 z-20 pt-6 px-6 pb-4 bg-gradient-to-b from-background-light/40 dark:from-background-dark/40 via-background-light/20 dark:via-background-dark/20 to-transparent flex items-center gap-3 pointer-events-none backdrop-blur-none">
      <div class="pointer-events-auto flex items-center gap-3">
        <div id="general-menu-wrapper" class="relative">
          <button id="btn-general-menu" type="button" class="flex items-center justify-center w-10 h-10 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-full border border-white/30 dark:border-white/10 shadow-lg text-slate-700 dark:text-white hover:bg-card-light/80 dark:hover:bg-card-dark/80 transition-colors cursor-pointer">
            <span class="material-symbols-outlined">menu</span>
          </button>
          <div id="general-menu-panel" class="general-menu-panel neumorphic-menu-panel" role="dialog" aria-label="General menu" aria-hidden="true">
            <div class="neumorphic-menu-section">
              <label for="theme-options">Theme</label>
              <div id="theme-options" class="neumorphic-theme-options" role="group" aria-label="Theme selection">
                <button type="button" class="neumorphic-btn" data-theme="light">Light</button>
                <button type="button" class="neumorphic-btn" data-theme="dark">Dark</button>
                <button type="button" class="neumorphic-btn" data-theme="system">System</button>
              </div>
            </div>
            <a href="resume.html" class="neumorphic-menu-resume">
              <span class="material-symbols-outlined">description</span>
              <span>Guillaume's Resume</span>
            </a>
          </div>
        </div>
        <button id="gps-status-btn" class="flex items-center gap-2 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl px-3 py-1.5 rounded-full border border-white/30 dark:border-white/10 shadow-lg">
          <span class="material-symbols-outlined text-green-500 dark:text-green-400 text-[18px]">my_location</span>
          <span class="text-xs font-semibold tracking-wide text-slate-700 dark:text-white">Location Active</span>
        </button>
      </div>
    </div>
    <!-- Right Side Controls -->
    <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex flex-col gap-3 z-20">
        <button id="map-zoom-in" class="w-12 h-12 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-xl flex items-center justify-center text-slate-700 dark:text-white shadow-lg border border-white/30 dark:border-white/10 active:scale-95 transition-transform">
          <span class="material-symbols-outlined">add</span>
        </button>
        <button id="map-zoom-out" class="w-12 h-12 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-xl flex items-center justify-center text-slate-700 dark:text-white shadow-lg border border-white/30 dark:border-white/10 active:scale-95 transition-transform">
          <span class="material-symbols-outlined">remove</span>
        </button>
        <button id="map-rotate" class="w-12 h-12 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-xl flex items-center justify-center text-slate-700 dark:text-white shadow-lg border border-white/30 dark:border-white/10 mt-2 active:scale-95 transition-transform" aria-pressed="false" title="Rotate globe">
          <span class="material-symbols-outlined">autorenew</span>
        </button>
        <button id="map-gps" class="w-12 h-12 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-xl flex items-center justify-center text-primary shadow-lg border border-white/30 dark:border-white/10 active:scale-95 transition-transform">
          <span class="material-symbols-outlined transform rotate-45">navigation</span>
        </button>
      </div>
    <!-- Bottom Panel (Emerging Tech Specialist) - trigger button centered, panel stays left -->
    <div id="bottom-panel-wrapper" class="absolute bottom-6 left-0 right-0 z-30 pointer-events-none overflow-visible h-12">
      <div class="pointer-events-auto relative w-full h-full">
        <button id="bottom-panel-toggle" type="button" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex items-center justify-center w-12 h-12 bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl rounded-full border border-white/30 dark:border-white/10 shadow-lg text-slate-700 dark:text-white hover:bg-card-light/80 dark:hover:bg-card-dark/80 transition-colors cursor-pointer" aria-expanded="false" aria-label="Open Emerging Tech Specialist">
          <span class="material-symbols-outlined transition-transform duration-200">keyboard_arrow_up</span>
        </button>
        <div id="bottom-panel" class="bottom-panel absolute bottom-full left-6 mb-2 w-[calc(100vw-48px)] max-w-[calc(100vw-48px)] max-h-[70vh] overflow-hidden flex flex-col bg-background-light/85 dark:bg-background-dark/85 backdrop-blur-xl rounded-2xl border border-white/30 dark:border-white/10 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] dark:shadow-[0_-10px_40px_rgba(0,0,0,0.5)]" aria-hidden="true">
          <div id="bottom-panel-content" class="overflow-y-auto overflow-x-hidden flex flex-col">
      <div class="px-6 pt-6 pb-4 flex items-center justify-between flex-shrink-0">
        <div>
          <h2 class="text-lg font-bold text-slate-800 dark:text-white">Emerging Tech Specialist</h2>
          <p id="nearby-friends-count" class="text-sm text-text-secondary">Lovely users</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-resume" type="button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-5 rounded-full shadow-[0_4px_20px_rgba(19,164,236,0.3)] flex items-center gap-2 active:scale-95 transition-transform cursor-pointer">
            <span class="material-symbols-outlined fill-current">description</span>
            <span>Guillaume's Resume</span>
          </button>
          <button id="bottom-panel-close" type="button" class="flex items-center justify-center w-10 h-10 rounded-full bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl hover:bg-card-light/80 dark:hover:bg-card-dark/80 border border-white/30 dark:border-white/10 text-slate-700 dark:text-white transition-colors cursor-pointer" aria-label="Close panel">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="flex gap-2 px-6 pb-2 flex-shrink-0">
        <button id="tab-nearby" type="button" class="tab-btn px-4 py-1.5 rounded-full text-sm font-medium bg-primary/20 text-primary border border-primary/30" data-tab="nearby">Nearby Friends</button>
        <button id="tab-poi" type="button" class="tab-btn px-4 py-1.5 rounded-full text-sm font-medium bg-transparent text-text-secondary border border-slate-200 dark:border-white/10 hover:border-slate-300 dark:hover:border-white/20" data-tab="poi">Points of Interest</button>
        <button id="tab-map-data" type="button" class="tab-btn px-4 py-1.5 rounded-full text-sm font-medium bg-transparent text-text-secondary border border-slate-200 dark:border-white/10 hover:border-slate-300 dark:hover:border-white/20" data-tab="map-data">Map Data</button>
      </div>
      <div class="w-full overflow-x-auto no-scrollbar pb-6 pl-6 flex-1 min-h-0">
        <div id="nearby-friends-tiles" class="flex gap-4 pr-6 w-max">
          <!-- Tiles rendered by map-app.js -->
        </div>
        <div id="poi-tiles" class="hidden flex gap-4 pr-6 w-max">
          <!-- POI tiles rendered by map-app.js -->
        </div>
        <div id="map-data-tiles" class="hidden flex gap-4 pr-6 w-max">
          <!-- Map Data toggle tiles rendered by map-app.js -->
        </div>
      </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating User Profile Panel (draggable, shown when clicking a person on map) -->
    <div id="user-profile-panel" class="hidden fixed z-40 w-72 rounded-2xl overflow-hidden bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-xl border border-white/30 dark:border-white/10 shadow-[0_10px_40px_rgba(0,0,0,0.2)] dark:shadow-[0_10px_40px_rgba(0,0,0,0.5)]" aria-hidden="true" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
      <div id="user-profile-drag-handle" class="flex items-center justify-between px-4 py-3 cursor-grab active:cursor-grabbing select-none bg-card-light/50 dark:bg-card-dark/50 border-b border-slate-200/50 dark:border-white/5">
        <div class="flex items-center gap-3 min-w-0 flex-1">
          <img id="user-profile-avatar" src="" alt="" class="w-12 h-12 rounded-full object-cover border-2 border-primary/30 flex-shrink-0"/>
          <div class="min-w-0">
            <h3 id="user-profile-name" class="font-bold text-slate-800 dark:text-white truncate">—</h3>
            <div class="flex items-center gap-1 text-text-secondary text-sm truncate">
              <span class="material-symbols-outlined text-[16px] flex-shrink-0">location_on</span>
              <span id="user-profile-location" class="truncate">—</span>
            </div>
          </div>
        </div>
        <button id="user-profile-close" type="button" class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-200/80 dark:hover:bg-white/10 text-slate-600 dark:text-slate-300 transition-colors" aria-label="Close profile">
          <span class="material-symbols-outlined text-[20px]">close</span>
        </button>
      </div>
    </div>

    <!-- Resume Embedded View (overlay on map) -->
    <div id="resume-embed-overlay" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4 bg-black/50 backdrop-blur-md">
      <div class="relative w-full max-w-[720px] bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/30 dark:border-white/10 overflow-hidden flex flex-col" style="max-height: 90vh;">
        <button id="resume-embed-close" type="button" class="absolute top-3 right-3 z-50 w-10 h-10 flex items-center justify-center rounded-full bg-card-light/60 dark:bg-card-dark/60 backdrop-blur-xl hover:bg-card-light/80 dark:hover:bg-card-dark/80 border border-white/30 dark:border-white/10 text-slate-700 dark:text-white transition-colors" aria-label="Close resume">
          <span class="material-symbols-outlined">close</span>
        </button>
        <iframe id="resume-embed-iframe" src="about:blank" class="w-full flex-1 min-h-[70vh] rounded-b-2xl border-0" title="Resume"></iframe>
      </div>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="toast-error" class="toast-error" role="alert">
    <span id="toast-error-message" class="text-sm text-slate-800 dark:text-white">Feature not yet implemented</span>
    <button type="button" class="toast-close" aria-label="Close" id="toast-error-close">
      <span class="material-symbols-outlined text-[18px]">close</span>
    </button>
  </div>

  <!-- Token Prompt Overlay (shown when no Mapbox token) -->
  <div id="map-token-overlay" class="hidden fixed inset-0 z-50 bg-background-light/95 dark:bg-background-dark/95 flex items-center justify-center p-6">
    <div class="bg-card-light dark:bg-card-dark rounded-2xl p-8 max-w-md w-full border border-slate-200 dark:border-white/5">
      <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Mapbox Token Required</h3>
      <p class="text-text-secondary text-sm mb-6">Enter your Mapbox Access Token to view the map.</p>
      <input type="text" id="mapbox-token-app" class="w-full px-4 py-3 rounded-xl bg-white/80 dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-white/40 mb-4" placeholder="Paste your Mapbox Access Token (pk....)">
      <button id="load-map-app" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 px-5 rounded-full">Load Map</button>
    </div>
  </div>

  <script src="js/mapbox-config.js"></script>
  <script src="js/api-config.js"></script>
  <script src="js/location-service.js"></script>
  <script src="js/map-app.js"></script>
  <script>
    if (!sessionStorage.getItem('osiris_authenticated')) {
      window.location.href = 'access-gate.html';
    } else {
      document.addEventListener('DOMContentLoaded', () => {
        renderNearbyTiles([]);
        initNotImplementedToast();
        initGeneralMenu();
        initMapApp();
        initBottomPanel();
        initUserProfilePanel();
        initResumeEmbed();
      });
    }
  </script>
</body>
</html>
